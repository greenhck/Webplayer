<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Player</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for the video container to maintain aspect ratio and center it */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
        }
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
    <!-- Load hls.js library -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">Live Stream Viewer</h1>
        <p class="text-gray-500 mb-6 text-center">Loading stream via CORS proxy...</p>

        <!-- Video Player Container (16:9 Aspect Ratio) -->
        <div class="video-container rounded-lg border-4 border-indigo-600 shadow-xl mb-6">
            <video id="video-player" controls autoplay class="rounded-md bg-black"></video>
        </div>

        <!-- Status/Error Message Box -->
        <div id="status-message" class="p-4 bg-indigo-100 border border-indigo-300 text-indigo-800 rounded-lg text-sm transition duration-300 ease-in-out">
            Initializing HLS stream...
        </div>

    </div>

    <script>
        // Global variables provided for the environment (required structure)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video-player');
            const statusMessage = document.getElementById('status-message');

            // --- Configuration ---
            const streamUrl = 'http://116.90.120.149:8000/play/a0bv/index.m3u8';
            const proxyUrl = 'https://cors-anywhere.24862486gill.workers.dev/';
            
            // Construct the final URL: Proxy + Stream URL
            const finalSource = proxyUrl + streamUrl;

            /**
             * Updates the status message box with color and text.
             * @param {string} text - The message content.
             * @param {string} type - 'info', 'error', or 'success'.
             */
            function updateStatus(text, type = 'info') {
                let classes = 'p-4 border text-sm rounded-lg';
                if (type === 'error') {
                    classes += ' bg-red-100 border-red-300 text-red-800';
                } else if (type === 'success') {
                    classes += ' bg-green-100 border-green-300 text-green-800';
                } else { // info
                    classes += ' bg-indigo-100 border-indigo-300 text-indigo-800';
                }
                statusMessage.className = classes;
                statusMessage.textContent = text;
            }


            if (Hls.isSupported()) {
                updateStatus('HLS is supported. Loading stream...');
                
                const hls = new Hls();

                // 1. Attach the video stream source
                hls.loadSource(finalSource);
                
                // 2. Attach the HLS object to the video element
                hls.attachMedia(video);

                // 3. Listen for HLS events for status updates
                hls.on(Hls.Events.MEDIA_ATTACHED, function () {
                    updateStatus('Media attached. Loading manifest...', 'info');
                    video.muted = true; // Mute initially to comply with autoplay policies
                    video.play()
                        .then(() => {
                            updateStatus('Stream loaded and attempting to play.', 'success');
                            video.muted = false; // Unmute if user interaction is detected later
                        })
                        .catch(e => {
                            updateStatus(`Autoplay failed (muted or unmuted). Please click 'Play' manually. (${e.message})`, 'info');
                        });
                });

                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                        let errorMessage = `Fatal HLS Error: ${data.details}.`;
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                errorMessage += ' A network issue occurred (CORS or stream URL might be unreachable/down).';
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                errorMessage += ' A media decoding error occurred.';
                                break;
                            default:
                                errorMessage += ' The stream could not be loaded.';
                                break;
                        }
                        updateStatus(errorMessage, 'error');
                        hls.destroy(); // Destroy HLS instance on fatal error
                    }
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // For native HLS support (e.g., Safari on desktop/mobile)
                updateStatus('Browser supports native HLS. Attempting direct load...', 'info');
                video.src = finalSource;
                video.addEventListener('loadedmetadata', function() {
                    video.play();
                });
                video.addEventListener('error', (e) => {
                     updateStatus(`Native player error: Could not load the stream. Check the proxy/URL.`, 'error');
                });
            } else {
                updateStatus('Your browser does not support HLS streaming. Please use a modern browser.', 'error');
            }
        });
    </script>

</body>
</html>
